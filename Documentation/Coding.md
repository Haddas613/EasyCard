# EasyCard coding guideline

## Git convention

1. Please use task number and colon at the beginning of commit comment. For example:

        ECNG-23: Shva integration draft

2. Preferred to use feature branches for functionality area implementation. For example:

        feature/ShvaIntegration

3. Each commit should contain only logical related set of changes if possible. Even if you are working with one task, it have sense to split changes to several commits in case of large amount of changes.

## Code style

Projects used Stylecop code style analyzers. Please follow refactoring suggestions ("show potential fixes" context menu in Visual Studio). _Note: build should not contain any warnings!_ (at least projects which you working on). Please take into account, that in nearest future all workings will be converted to errors.

For example, you should wrap `if` statement should be wrapped by braces. For example

            if (src == null)
                throw new EntityNotFoundException(...);

should be

            if (src == null)
            {
                throw new EntityNotFoundException(...);
            }

Please care about spaces in formatting etc. You can use Visual Studio extension [Format All Files](https://marketplace.visualstudio.com/items?itemName=munyabe.FormatAllFiles).

It is very important to keep code clean, especially for cases like merge or automated Roslyn-based refactoring.

Try to use latest C# features, including pattern matching (use Visual Studio suggestions)

## Project structure

1. Dependencies structure - integration projects. Api projects should know only integration contracts from Shared.Integration - do not add reference on integration projects (like Shva, ClearingHouse etc,) directly to Api and Business projects.

![Project dependencies](images/Projects.png)

2. Use existing helpers. Add new helpers if needed to existing helpers libraries

## Entity framework convention

1. Please contact to other developers before adding migrations or updating databases on QA environment - _it is not possible to merge migrations_

2. Preferred not to use collections properties. In case if you decided to use collection, please ensure that generated query does not load extra data. You can use [\EasyCard\Shared.Business\Extensions\IQueryableExtensions.cs](../EasyCard/Shared.Business/Extensions/IQueryableExtensions.cs) to view SQL generated by EntityFramework (to be used only on development stage). As well you can see generated SQL in Visual Studio and Azure output console.

3. Use security filters for each queryable

4. Use `AsNoTracking()` for all queries

## Documentation

1. For the moment documentation headers validation for classes and class members are disabled, but it will be re-enabled in nearest future to keep public Apis clean. So please care about documentation if possible.

## Localization

1. User resource files for localization

## Testing

TBC

## API convention

1. Please keep API methods as simple as possible. We have decided to use `ActionResult<T>` as response (instead of `T` itself or abstract `IActionResult`). It allows to return not only object result itself, but for example `NotFoundObjectResult` etc. Use `Ok(...);` or `CreatedAtAction(...)` (or other appropriate controller base methods) to generate response. You can use `MerchantApiController` as reference. Please keep next headers on controller class: `[Produces("application/json")]` and `[Consumes("application/json")]`.

2. Please use `EnsureExists()` extension to check if entity exists. It will generate `EntityNotFoundException` which automatically catches by global exception handler and appropriate response will be generated automatically.

3. General json settings are configured at startup:

            services.AddControllers()
                .AddNewtonsoftJson(options =>
                {
                    options.SerializerSettings.Converters.Add(new StringEnumConverter());
                    options.SerializerSettings.ContractResolver = new CamelCasePropertyNamesContractResolver();
                    options.SerializerSettings.DefaultValueHandling = DefaultValueHandling.Include;
                });

    Note: do not use `options.SerializerSettings.NullValueHandling = NullValueHandling.Ignore;`: please use `[JsonObject(ItemNullValueHandling = NullValueHandling.Ignore)]` attribute _only_ on models, which you want to keep clean from `null` json values                

4. Models validation - TBC

