<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="947px" preserveAspectRatio="none" style="width:1535px;height:947px;background:#003153;" version="1.1" viewBox="0 0 1535 947" width="1535px" zoomAndPan="magnify"><defs/><g><rect fill="#003153" height="947" style="stroke:none;stroke-width:1.0;" width="1535" x="0" y="0"/><rect fill="#003153" height="496.5234" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="254" y="67.4297"/><rect fill="#003153" height="313.1953" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="517" y="563.9531"/><rect fill="#003153" height="244.0625" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="697" y="96.5625"/><rect fill="#003153" height="170.6641" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="891" y="125.6953"/><rect fill="#003153" height="254.9297" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="891" y="593.0859"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="63" x2="63" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="259" x2="259" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="521.5" x2="521.5" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="702" x2="702" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="896" x2="896" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1208" x2="1208" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1385.5" x2="1385.5" y1="36.2969" y2="912.2813"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1481.5" x2="1481.5" y1="36.2969" y2="912.2813"/><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="86" x="20" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="27" y="24.9951">Consumer</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="86" x="20" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="27" y="931.2764">Consumer</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="110" x="204" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="96" x="211" y="24.9951">Checkout (JS)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="110" x="204" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="96" x="211" y="931.2764">Checkout (JS)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="129" x="457.5" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="115" x="464.5" y="24.9951">Checkout (MVC)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="129" x="457.5" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="115" x="464.5" y="931.2764">Checkout (MVC)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="120" x="642" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="649" y="24.9951">Checkout (API)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="120" x="642" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="649" y="931.2764">Checkout (API)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="106" x="843" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92" x="850" y="24.9951">EasyCard API</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="106" x="843" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92" x="850" y="931.2764">EasyCard API</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="62" x="1177" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="48" x="1184" y="24.9951">bit (UI)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="62" x="1177" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="48" x="1184" y="931.2764">bit (UI)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="35" x="1368.5" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1375.5" y="24.9951">bit</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="35" x="1368.5" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1375.5" y="931.2764">bit</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="96" x="1433.5" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="82" x="1440.5" y="24.9951">Aggregator</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="96" x="1433.5" y="911.2813"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="82" x="1440.5" y="931.2764">Aggregator</text><rect fill="#003153" height="496.5234" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="254" y="67.4297"/><rect fill="#003153" height="313.1953" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="517" y="563.9531"/><rect fill="#003153" height="244.0625" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="697" y="96.5625"/><rect fill="#003153" height="170.6641" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="891" y="125.6953"/><rect fill="#003153" height="254.9297" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="891" y="593.0859"/><polygon fill="#00FFFF" points="242,63.4297,252,67.4297,242,71.4297,246,67.4297" style="stroke:#00FFFF;stroke-width:1.0;"/><line style="stroke:#00FFFF;stroke-width:1.0;" x1="63" x2="248" y1="67.4297" y2="67.4297"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172" x="70" y="62.3638">press "Pay With bit" button</text><polygon fill="#FFFF00" points="685,92.5625,695,96.5625,685,100.5625,689,96.5625" style="stroke:#FFFF00;stroke-width:1.0;"/><line style="stroke:#FFFF00;stroke-width:1.0;" x1="264" x2="691" y1="96.5625" y2="96.5625"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="271" y="91.4966">call "Charge" method via ajax</text><polygon fill="#D9D3D0" points="879,121.6953,889,125.6953,879,129.6953,883,125.6953" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="707" x2="885" y1="125.6953" y2="125.6953"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="21" x="714" y="120.6294">call</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="140" x="739" y="120.6294">InitiateBitTransaction</text><polygon fill="#D9D3D0" points="1374,150.8281,1384,154.8281,1374,158.8281,1378,154.8281" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="901" x2="1380" y1="154.8281" y2="154.8281"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="258" x="908" y="149.7622">POST /payments/bit/v2/single-payments</text><polygon fill="#D9D3D0" points="912,162.8281,902,166.8281,912,170.8281,908,166.8281" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="906" x2="1385" y1="166.8281" y2="166.8281"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="39" x="918" y="179.895">return</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="282" x="961" y="179.895">transactionSerialId and paymentInitiationId</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="901" x2="943" y1="213.0938" y2="213.0938"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="943" x2="943" y1="213.0938" y2="226.0938"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="902" x2="943" y1="226.0938" y2="226.0938"/><polygon fill="#FF00FF" points="912,222.0938,902,226.0938,912,230.0938,908,226.0938" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="41" x="908" y="208.0278">create</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="134" x="953" y="208.0278">PaymentTransaction</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="41" x="1091" y="208.0278">record</text><polygon fill="#D9D3D0" points="1469.5,251.2266,1479.5,255.2266,1469.5,259.2266,1473.5,255.2266" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="901" x2="1475.5" y1="255.2266" y2="255.2266"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="908" y="250.1606">create Deal</text><polygon fill="#D9D3D0" points="912,263.2266,902,267.2266,912,271.2266,908,267.2266" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="906" x2="1480.5" y1="267.2266" y2="267.2266"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="918" y="280.2935">operation response (success)</text><polygon fill="#D9D3D0" points="718,292.3594,708,296.3594,718,300.3594,714,296.3594" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="712" x2="895" y1="296.3594" y2="296.3594"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="724" y="309.4263">transactionSerialId</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="151" x="724" y="324.5591">and paymentInitiationId</text><polygon fill="#FFFF00" points="533,336.625,523,340.625,533,344.625,529,340.625" style="stroke:#FFFF00;stroke-width:1.0;"/><line style="stroke:#FFFF00;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="527" x2="701" y1="340.625" y2="340.625"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="539" y="353.6919">transactionSerialId</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="151" x="539" y="368.8247">and paymentInitiationId</text><polygon fill="#FF0000" points="1196,413.1563,1206,417.1563,1196,421.1563,1200,417.1563" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="522" x2="1202" y1="417.1563" y2="417.1563"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="116" x="529" y="396.9575">initiate bit window</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="410" x="529" y="412.0903">(pass transactionSerialId and paymentInitiationId as arguments)</text><polygon fill="#00FFFF" points="74,425.1563,64,429.1563,74,433.1563,70,429.1563" style="stroke:#00FFFF;stroke-width:1.0;"/><line style="stroke:#00FFFF;stroke-width:1.0;" x1="68" x2="1207" y1="429.1563" y2="429.1563"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="210" x="80" y="442.2231">bit popup displayed to consumer</text><polygon fill="#00FFFF" points="1196,471.4219,1206,475.4219,1196,479.4219,1200,475.4219" style="stroke:#00FFFF;stroke-width:1.0;"/><line style="stroke:#00FFFF;stroke-width:1.0;" x1="63" x2="1202" y1="475.4219" y2="475.4219"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="373" x="70" y="470.356">use bit app to make payment (QR code or phone number)</text><polygon fill="#FF0000" points="275,483.4219,265,487.4219,275,491.4219,271,487.4219" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="269" x2="1207" y1="487.4219" y2="487.4219"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155" x="281" y="500.4888">call onApproved handler</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="95" x="281" y="515.6216">(popup closed)</text><polygon fill="#00FF00" points="505,559.9531,515,563.9531,505,567.9531,509,563.9531" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="259" x2="511" y1="563.9531" y2="563.9531"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="234" x="266" y="543.7544">POST form to BitPaymentCompleted</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123" x="266" y="558.8872">(programmatically)</text><polygon fill="#D9D3D0" points="879,589.0859,889,593.0859,879,597.0859,883,593.0859" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="527" x2="885" y1="593.0859" y2="593.0859"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167" x="534" y="588.02">call CaptureBitTransaction</text><polygon fill="#D9D3D0" points="1374,618.2188,1384,622.2188,1374,626.2188,1378,622.2188" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="901" x2="1380" y1="622.2188" y2="622.2188"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="461" x="908" y="617.1528">POST /payments/bit/v2/single-payments/{PaymentInitiationId)}/capture</text><polygon fill="#D9D3D0" points="912,630.2188,902,634.2188,912,638.2188,908,634.2188" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="906" x2="1385" y1="634.2188" y2="634.2188"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="918" y="647.2856">operation response (success)</text><polygon fill="#D9D3D0" points="1469.5,676.4844,1479.5,680.4844,1469.5,684.4844,1473.5,680.4844" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="901" x2="1475.5" y1="680.4844" y2="680.4844"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82" x="908" y="675.4185">commit Deal</text><polygon fill="#D9D3D0" points="912,688.4844,902,692.4844,912,696.4844,908,692.4844" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="906" x2="1480.5" y1="692.4844" y2="692.4844"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="918" y="705.5513">operation response (success)</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="901" x2="943" y1="738.75" y2="738.75"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="943" x2="943" y1="738.75" y2="751.75"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="902" x2="943" y1="751.75" y2="751.75"/><polygon fill="#FF00FF" points="912,747.75,902,751.75,912,755.75,908,751.75" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="288" x="908" y="733.6841">update status of PaymentTransaction record</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="901" x2="943" y1="780.8828" y2="780.8828"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="943" x2="943" y1="780.8828" y2="793.8828"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="902" x2="943" y1="793.8828" y2="793.8828"/><polygon fill="#FF00FF" points="912,789.8828,902,793.8828,912,797.8828,908,793.8828" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139" x="908" y="775.8169">delete PaymentIntent</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="901" x2="943" y1="823.0156" y2="823.0156"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="943" x2="943" y1="823.0156" y2="836.0156"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="902" x2="943" y1="836.0156" y2="836.0156"/><polygon fill="#FF00FF" points="912,832.0156,902,836.0156,912,840.0156,908,836.0156" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82" x="908" y="817.9497">issue Invoice</text><polygon fill="#D9D3D0" points="538,844.0156,528,848.0156,538,852.0156,534,848.0156" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="532" x2="895" y1="848.0156" y2="848.0156"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="124" x="544" y="861.0825">operation response</text><polygon fill="#00FF00" points="74,873.1484,64,877.1484,74,881.1484,70,877.1484" style="stroke:#00FF00;stroke-width:1.0;"/><line style="stroke:#00FF00;stroke-width:1.0;" x1="68" x2="521" y1="877.1484" y2="877.1484"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="187" x="80" y="890.2153">redirect to confirmation page</text><!--MD5=[40effa985bd6775c7aa23d81b88a7251]
@startuml
!theme blueprint
skinparam responseMessageBelowArrow true
participant "Consumer" as consumer

participant "Checkout (JS)" as checkout_ui
participant "Checkout (MVC)" as checkout
participant "Checkout (API)" as checkout_backend

participant "EasyCard API" as api
participant "bit (UI)" as bit_ui
participant bit
participant Aggregator

consumer-[#aqua]>checkout_ui : press "Pay With bit" button

activate checkout_ui
checkout_ui-[#yellow]>checkout_backend: call "Charge" method via ajax

activate checkout_backend
checkout_backend->api: call //InitiateBitTransaction//
activate api
api->bit: POST /payments/bit/v2/single-payments
bit- ->api: return //transactionSerialId and paymentInitiationId//
api-[#fuchsia]>api: create //PaymentTransaction// record
api->Aggregator: create Deal
Aggregator- ->api: operation response (success)
api- ->checkout_backend: transactionSerialId\nand paymentInitiationId
deactivate api
checkout_backend- -[#yellow]>checkout: transactionSerialId\nand paymentInitiationId
deactivate checkout_backend

checkout-[#red]>bit_ui: initiate bit window\n(pass transactionSerialId and paymentInitiationId as arguments)

bit_ui-[#aqua]>consumer: bit popup displayed to consumer
consumer-[#aqua]>bit_ui: use bit app to make payment (QR code or phone number)
bit_ui-[#red]>checkout_ui: call onApproved handler\n(popup closed)



checkout_ui-[#lime]>checkout: POST form to BitPaymentCompleted\n(programmatically)
deactivate checkout_ui
activate checkout
checkout->api: call CaptureBitTransaction

activate api
api->bit: POST /payments/bit/v2/single-payments/{PaymentInitiationId)}/capture
bit- ->api: operation response (success)
api->Aggregator: commit Deal
Aggregator- ->api: operation response (success)
api-[#fuchsia]>api: update status of PaymentTransaction record
api-[#fuchsia]>api: delete PaymentIntent
api-[#fuchsia]>api: issue Invoice
api- ->checkout: operation response
deactivate api

checkout-[#lime]> consumer: redirect to confirmation page
deactivate checkout
@enduml

@startuml





<style>
  root {
    BackgroundColor #003153
    FontColor #D9D3D0
    FontName Verdana
    HyperLinkColor #D9D3D0
    LineColor #D9D3D0
    LineThickness 1
    Margin 5
  }
  caption {
    LineThickness 0
  }
  footer {
    LineThickness 0
  }
  header {
    LineThickness 0
  }
  node {
    MaximumWidth 300
  }
  title {
    FontSize 22
    LineThickness 0
  }
</style>

skinparam ArrowLollipopColor #D9D3D0
skinparam BackgroundColor #003153
skinparam DefaultFontName Verdana
skinparam DefaultMonospacedFontName Courier
skinparam LifelineStrategy nosolid
skinparam ParticipantPadding 10
skinparam SequenceLifeLineBorderColor #D9D3D0
skinparam Shadowing false
skinparam UseBetaStyle true

skinparam Activity {
  BackgroundColor #003153
  BarColor #D9D3D0
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Boundary {
  FontColor #D9D3D0
}
skinparam Box {
  Padding 5
}
skinparam CircledCharacter {
  FontColor #D9D3D0
  FontName Courier
  Radius 9
}
skinparam Class {
  BackgroundColor #003153
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam ClassAttribute {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam ClassStereotype {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Footer {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Header {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Hyperlink {
  Color #D9D3D0
}
skinparam IconPackage {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconPrivate {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconProtected {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconPublic {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam Note {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Object {
  BorderColor #D9D3D0
}
skinparam Package {
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam State {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeA {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeC {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeE {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeI {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeN {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam UseCaseStereoType {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam responseMessageBelowArrow true
participant "Consumer" as consumer

participant "Checkout (JS)" as checkout_ui
participant "Checkout (MVC)" as checkout
participant "Checkout (API)" as checkout_backend

participant "EasyCard API" as api
participant "bit (UI)" as bit_ui
participant bit
participant Aggregator

consumer-[#aqua]>checkout_ui : press "Pay With bit" button

activate checkout_ui
checkout_ui-[#yellow]>checkout_backend: call "Charge" method via ajax

activate checkout_backend
checkout_backend->api: call //InitiateBitTransaction//
activate api
api->bit: POST /payments/bit/v2/single-payments
bit- ->api: return //transactionSerialId and paymentInitiationId//
api-[#fuchsia]>api: create //PaymentTransaction// record
api->Aggregator: create Deal
Aggregator- ->api: operation response (success)
api- ->checkout_backend: transactionSerialId\nand paymentInitiationId
deactivate api
checkout_backend- -[#yellow]>checkout: transactionSerialId\nand paymentInitiationId
deactivate checkout_backend

checkout-[#red]>bit_ui: initiate bit window\n(pass transactionSerialId and paymentInitiationId as arguments)

bit_ui-[#aqua]>consumer: bit popup displayed to consumer
consumer-[#aqua]>bit_ui: use bit app to make payment (QR code or phone number)
bit_ui-[#red]>checkout_ui: call onApproved handler\n(popup closed)



checkout_ui-[#lime]>checkout: POST form to BitPaymentCompleted\n(programmatically)
deactivate checkout_ui
activate checkout
checkout->api: call CaptureBitTransaction

activate api
api->bit: POST /payments/bit/v2/single-payments/{PaymentInitiationId)}/capture
bit- ->api: operation response (success)
api->Aggregator: commit Deal
Aggregator- ->api: operation response (success)
api-[#fuchsia]>api: update status of PaymentTransaction record
api-[#fuchsia]>api: delete PaymentIntent
api-[#fuchsia]>api: issue Invoice
api- ->checkout: operation response
deactivate api

checkout-[#lime]> consumer: redirect to confirmation page
deactivate checkout
@enduml

PlantUML version 1.2022.14beta6(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>