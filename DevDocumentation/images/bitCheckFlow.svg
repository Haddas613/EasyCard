<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="883px" preserveAspectRatio="none" style="width:1126px;height:883px;background:#003153;" version="1.1" viewBox="0 0 1126 883" width="1126px" zoomAndPan="magnify"><defs/><g><rect fill="#003153" height="883" style="stroke:none;stroke-width:1.0;" width="1126" x="0" y="0"/><rect fill="#003153" height="718.3359" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="332.5" y="93.7266"/><rect fill="#003153" height="559.5391" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="629.5" y="220.3906"/><rect fill="#003153" height="638.0703" style="stroke:#D9D3D0;stroke-width:1.0;" width="925" x="195" y="166.9922"/><rect fill="#003153" height="86.0078" style="stroke:#D9D3D0;stroke-width:1.0;" width="422.5" x="561.5" y="293.6563"/><rect fill="#003153" height="317" style="stroke:#D9D3D0;stroke-width:1.0;" width="548.5" x="561.5" y="451.9297"/><rect fill="#003153" height="115.2031" style="stroke:none;stroke-width:1.0;" width="548.5" x="561.5" y="653.7266"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="102" x2="102" y1="62.5938" y2="822.0625"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="337" x2="337" y1="62.5938" y2="822.0625"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="634.5" x2="634.5" y1="62.5938" y2="822.0625"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="946" x2="946" y1="62.5938" y2="822.0625"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1042" x2="1042" y1="62.5938" y2="822.0625"/><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="165" x="20" y="31.2969"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="151" x="27" y="51.292">Azure Functions Host</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="165" x="20" y="821.0625"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="151" x="27" y="841.0576">Azure Functions Host</text><rect fill="#003153" height="56.5938" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="245" x="215" y="5"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="121" x="275" y="24.9951">"Azure Function"</text><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="215" x2="460" y1="33.2969" y2="33.2969"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="231" x="222" y="51.292">(PostProcessingBitTransactions)</text><rect fill="#003153" height="56.5938" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="245" x="215" y="821.0625"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="121" x="275" y="841.0576">"Azure Function"</text><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="215" x2="460" y1="849.3594" y2="849.3594"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="231" x="222" y="867.3545">(PostProcessingBitTransactions)</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="106" x="581.5" y="31.2969"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92" x="588.5" y="51.292">EasyCard API</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="106" x="581.5" y="821.0625"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92" x="588.5" y="841.0576">EasyCard API</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="35" x="929" y="31.2969"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="936" y="51.292">bit</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="35" x="929" y="821.0625"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="936" y="841.0576">bit</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="96" x="994" y="31.2969"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="82" x="1001" y="51.292">Aggregator</text><rect fill="#003153" height="30.2969" rx="2.5" ry="2.5" style="stroke:#D9D3D0;stroke-width:1.0;" width="96" x="994" y="821.0625"/><text fill="#D9D3D0" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="82" x="1001" y="841.0576">Aggregator</text><rect fill="#003153" height="718.3359" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="332.5" y="93.7266"/><rect fill="#003153" height="559.5391" style="stroke:#D9D3D0;stroke-width:1.0;" width="10" x="629.5" y="220.3906"/><polygon fill="#00FFFF" points="320.5,89.7266,330.5,93.7266,320.5,97.7266,324.5,93.7266" style="stroke:#00FFFF;stroke-width:1.0;"/><line style="stroke:#00FFFF;stroke-width:1.0;" x1="102.5" x2="326.5" y1="93.7266" y2="93.7266"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80" x="109.5" y="88.6606">timer trigger</text><polygon fill="#D9D3D0" points="622.5,118.8594,632.5,122.8594,622.5,126.8594,626.5,122.8594" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="342.5" x2="628.5" y1="122.8594" y2="122.8594"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="179" x="349.5" y="117.7935">get pending bit transactions</text><polygon fill="#D9D3D0" points="353.5,130.8594,343.5,134.8594,353.5,138.8594,349.5,134.8594" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="347.5" x2="633.5" y1="134.8594" y2="134.8594"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154" x="359.5" y="147.9263">pending bit transactions</text><path d="M195,166.9922 L273,166.9922 L273,174.125 L263,184.125 L195,184.125 L195,166.9922 " fill="#003153" style="stroke:#D9D3D0;stroke-width:1.0;"/><rect fill="none" height="638.0703" style="stroke:#D9D3D0;stroke-width:1.0;" width="925" x="195" y="166.9922"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="210" y="180.0591">loop</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="169" x="288" y="179.2026">[foreach bit transaction]</text><polygon fill="#D9D3D0" points="617.5,216.3906,627.5,220.3906,617.5,224.3906,621.5,220.3906" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="342.5" x2="623.5" y1="220.3906" y2="220.3906"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="21" x="349.5" y="200.1919">call</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="192" x="374.5" y="200.1919">BitTransactionPostProcessing</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="268" x="349.5" y="215.3247">(api/external/bit/cancelOrConfirmPending)</text><polygon fill="#D9D3D0" points="934.5,245.5234,944.5,249.5234,934.5,253.5234,938.5,249.5234" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="639.5" x2="940.5" y1="249.5234" y2="249.5234"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="117" x="646.5" y="244.4575">get transaction by</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="146" x="767.5" y="244.4575">BitPaymentInitiationId</text><polygon fill="#D9D3D0" points="650.5,257.5234,640.5,261.5234,650.5,265.5234,646.5,261.5234" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="644.5" x2="945.5" y1="261.5234" y2="261.5234"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="656.5" y="274.5903">bit transaction details</text><path d="M561.5,293.6563 L627.5,293.6563 L627.5,300.7891 L617.5,310.7891 L561.5,310.7891 L561.5,293.6563 " fill="#003153" style="stroke:#D9D3D0;stroke-width:1.0;"/><rect fill="none" height="86.0078" style="stroke:#D9D3D0;stroke-width:1.0;" width="422.5" x="561.5" y="293.6563"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="576.5" y="306.7231">alt</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="296" x="642.5" y="305.8667">[bitTransaction.BitRequestStatusCode == 9</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="93" x="642.5" y="318.6714">(intermediate</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="163" x="739.5" y="318.6714">CreditExtensionPerformed</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="54" x="906.5" y="318.6714">status)]</text><polygon fill="#D9D3D0" points="934.5,338.5313,944.5,342.5313,934.5,346.5313,938.5,342.5313" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="639.5" x2="940.5" y1="342.5313" y2="342.5313"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="127" x="646.5" y="337.4653">Capture transaction</text><polygon fill="#D9D3D0" points="650.5,350.5313,640.5,354.5313,650.5,358.5313,646.5,354.5313" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="644.5" x2="945.5" y1="354.5313" y2="354.5313"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="656.5" y="367.5981">operation response (success)</text><polygon fill="#D9D3D0" points="934.5,403.7969,944.5,407.7969,934.5,411.7969,938.5,407.7969" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="639.5" x2="940.5" y1="407.7969" y2="407.7969"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="117" x="646.5" y="402.731">get transaction by</text><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="146" x="767.5" y="402.731">BitPaymentInitiationId</text><polygon fill="#D9D3D0" points="650.5,415.7969,640.5,419.7969,650.5,423.7969,646.5,419.7969" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="644.5" x2="945.5" y1="419.7969" y2="419.7969"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="656.5" y="432.8638">bit transaction details</text><path d="M561.5,451.9297 L627.5,451.9297 L627.5,459.0625 L617.5,469.0625 L561.5,469.0625 L561.5,451.9297 " fill="#003153" style="stroke:#D9D3D0;stroke-width:1.0;"/><rect fill="none" height="317" style="stroke:#D9D3D0;stroke-width:1.0;" width="548.5" x="561.5" y="451.9297"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="576.5" y="464.9966">alt</text><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="187" x="642.5" y="464.1401">[bit transaction completed]</text><polygon fill="#D9D3D0" points="1030,486.1953,1040,490.1953,1030,494.1953,1034,490.1953" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="639.5" x2="1036" y1="490.1953" y2="490.1953"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82" x="646.5" y="485.1294">commit Deal</text><polygon fill="#D9D3D0" points="650.5,498.1953,640.5,502.1953,650.5,506.1953,646.5,502.1953" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="644.5" x2="1041" y1="502.1953" y2="502.1953"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="656.5" y="515.2622">operation response (success)</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="639.5" x2="681.5" y1="548.4609" y2="548.4609"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="681.5" x2="681.5" y1="548.4609" y2="561.4609"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="640.5" x2="681.5" y1="561.4609" y2="561.4609"/><polygon fill="#FF00FF" points="650.5,557.4609,640.5,561.4609,650.5,565.4609,646.5,561.4609" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="288" x="646.5" y="543.395">update status of PaymentTransaction record</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="639.5" x2="681.5" y1="590.5938" y2="590.5938"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="681.5" x2="681.5" y1="590.5938" y2="603.5938"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="640.5" x2="681.5" y1="603.5938" y2="603.5938"/><polygon fill="#FF00FF" points="650.5,599.5938,640.5,603.5938,650.5,607.5938,646.5,603.5938" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139" x="646.5" y="585.5278">delete PaymentIntent</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="639.5" x2="681.5" y1="632.7266" y2="632.7266"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="681.5" x2="681.5" y1="632.7266" y2="645.7266"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="640.5" x2="681.5" y1="645.7266" y2="645.7266"/><polygon fill="#FF00FF" points="650.5,641.7266,640.5,645.7266,650.5,649.7266,646.5,645.7266" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82" x="646.5" y="627.6606">issue Invoice</text><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="561.5" x2="1110" y1="654.7266" y2="654.7266"/><text fill="#D9D3D0" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="174" x="566.5" y="664.937">[bit transaction canceled]</text><polygon fill="#D9D3D0" points="1030,685.6641,1040,689.6641,1030,693.6641,1034,689.6641" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;" x1="639.5" x2="1036" y1="689.6641" y2="689.6641"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="72" x="646.5" y="684.5981">cancel deal</text><polygon fill="#D9D3D0" points="650.5,697.6641,640.5,701.6641,650.5,705.6641,646.5,701.6641" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="644.5" x2="1041" y1="701.6641" y2="701.6641"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189" x="656.5" y="714.731">operation response (success)</text><line style="stroke:#FF00FF;stroke-width:1.0;" x1="639.5" x2="681.5" y1="747.9297" y2="747.9297"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="681.5" x2="681.5" y1="747.9297" y2="760.9297"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="640.5" x2="681.5" y1="760.9297" y2="760.9297"/><polygon fill="#FF00FF" points="650.5,756.9297,640.5,760.9297,650.5,764.9297,646.5,760.9297" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="288" x="646.5" y="742.8638">update status of PaymentTransaction record</text><polygon fill="#D9D3D0" points="353.5,775.9297,343.5,779.9297,353.5,783.9297,349.5,779.9297" style="stroke:#D9D3D0;stroke-width:1.0;"/><line style="stroke:#D9D3D0;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="347.5" x2="633.5" y1="779.9297" y2="779.9297"/><text fill="#D9D3D0" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="124" x="359.5" y="792.9966">operation response</text><!--MD5=[2209b572a44f60edf869c25241cee89c]
@startuml
!theme blueprint
skinparam responseMessageBelowArrow true
participant "Azure Functions Host" as azure_function_host
participant azure_function [
"Azure Function" 
- - - -
(PostProcessingBitTransactions)
]
participant "EasyCard API" as api
participant bit
participant Aggregator


azure_function_host-[#aqua]>azure_function : timer trigger
activate azure_function
azure_function->api: get pending bit transactions
api- ->azure_function: pending bit transactions

loop foreach bit transaction

	azure_function->api: call //BitTransactionPostProcessing//\n(api/external/bit/cancelOrConfirmPending)
	activate api
	api->bit: get transaction by //BitPaymentInitiationId//
	bit- ->api: bit transaction details
	alt bitTransaction.BitRequestStatusCode == 9\n(intermediate //CreditExtensionPerformed// status)
		api->bit: Capture transaction
		bit- ->api: operation response (success)
	end
	
	api->bit: get transaction by //BitPaymentInitiationId//
	bit- ->api: bit transaction details
	alt bit transaction completed
		api->Aggregator: commit Deal
		Aggregator- ->api: operation response (success)
		api-[#fuchsia]>api: update status of PaymentTransaction record
		api-[#fuchsia]>api: delete PaymentIntent
		api-[#fuchsia]>api: issue Invoice
	else bit transaction canceled
		api->Aggregator: cancel deal
		Aggregator- ->api: operation response (success)
		api-[#fuchsia]>api: update status of PaymentTransaction record
	end
	
	api- ->azure_function: operation response
	deactivate api
end

deactivate azure_function
@enduml

@startuml





<style>
  root {
    BackgroundColor #003153
    FontColor #D9D3D0
    FontName Verdana
    HyperLinkColor #D9D3D0
    LineColor #D9D3D0
    LineThickness 1
    Margin 5
  }
  caption {
    LineThickness 0
  }
  footer {
    LineThickness 0
  }
  header {
    LineThickness 0
  }
  node {
    MaximumWidth 300
  }
  title {
    FontSize 22
    LineThickness 0
  }
</style>

skinparam ArrowLollipopColor #D9D3D0
skinparam BackgroundColor #003153
skinparam DefaultFontName Verdana
skinparam DefaultMonospacedFontName Courier
skinparam LifelineStrategy nosolid
skinparam ParticipantPadding 10
skinparam SequenceLifeLineBorderColor #D9D3D0
skinparam Shadowing false
skinparam UseBetaStyle true

skinparam Activity {
  BackgroundColor #003153
  BarColor #D9D3D0
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Boundary {
  FontColor #D9D3D0
}
skinparam Box {
  Padding 5
}
skinparam CircledCharacter {
  FontColor #D9D3D0
  FontName Courier
  Radius 9
}
skinparam Class {
  BackgroundColor #003153
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam ClassAttribute {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam ClassStereotype {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Footer {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Header {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Hyperlink {
  Color #D9D3D0
}
skinparam IconPackage {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconPrivate {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconProtected {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam IconPublic {
  Color #D9D3D0
  BackgroundColor #003153
}
skinparam Note {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam Object {
  BorderColor #D9D3D0
}
skinparam Package {
  BorderColor #D9D3D0
  FontColor #D9D3D0
  FontName Verdana
}
skinparam State {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeA {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeC {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeE {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeI {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam StereotypeN {
  BackgroundColor #003153
  BorderColor #D9D3D0
}
skinparam UseCaseStereoType {
  FontColor #D9D3D0
  FontName Verdana
}
skinparam responseMessageBelowArrow true
participant "Azure Functions Host" as azure_function_host
participant azure_function [
"Azure Function" 
- - - -
(PostProcessingBitTransactions)
]
participant "EasyCard API" as api
participant bit
participant Aggregator


azure_function_host-[#aqua]>azure_function : timer trigger
activate azure_function
azure_function->api: get pending bit transactions
api- ->azure_function: pending bit transactions

loop foreach bit transaction

	azure_function->api: call //BitTransactionPostProcessing//\n(api/external/bit/cancelOrConfirmPending)
	activate api
	api->bit: get transaction by //BitPaymentInitiationId//
	bit- ->api: bit transaction details
	alt bitTransaction.BitRequestStatusCode == 9\n(intermediate //CreditExtensionPerformed// status)
		api->bit: Capture transaction
		bit- ->api: operation response (success)
	end
	
	api->bit: get transaction by //BitPaymentInitiationId//
	bit- ->api: bit transaction details
	alt bit transaction completed
		api->Aggregator: commit Deal
		Aggregator- ->api: operation response (success)
		api-[#fuchsia]>api: update status of PaymentTransaction record
		api-[#fuchsia]>api: delete PaymentIntent
		api-[#fuchsia]>api: issue Invoice
	else bit transaction canceled
		api->Aggregator: cancel deal
		Aggregator- ->api: operation response (success)
		api-[#fuchsia]>api: update status of PaymentTransaction record
	end
	
	api- ->azure_function: operation response
	deactivate api
end

deactivate azure_function
@enduml

PlantUML version 1.2022.14beta7(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>